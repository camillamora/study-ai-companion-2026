<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Study Dashboard - Study Companion AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2E7D32;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #2E7D32;
            margin-bottom: 25px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .material-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .material-card:hover {
            border-color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.1);
        }
        
        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .material-title {
            font-weight: bold;
            color: #2E7D32;
            font-size: 1.1em;
        }
        
        .material-date {
            color: #666;
            font-size: 0.8em;
            background: #e0e0e0;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .material-content {
            margin: 15px 0;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .material-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, #f8f9fa);
        }
        
        .material-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .review-btn {
            background: #4CAF50;
            color: white;
            flex: 1;
        }
        
        .delete-btn {
            background: #f44336;
            color: white;
        }
        
        .review-btn:hover {
            background: #3d8b40;
        }
        
        .delete-btn:hover {
            background: #d32f2f;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 3em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .nav-btn {
            padding: 12px 30px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn:hover {
            background: #0b7dda;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-title {
            color: #2E7D32;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        @media (max-width: 768px) {
            .materials-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .material-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Study Dashboard</h1>
            <p>Track your learning progress and review saved materials</p>
            
            <div class="user-info">
                <div>
                    <strong id="usernameDisplay">Loading...</strong>
                    <div style="font-size: 0.9em; opacity: 0.9;">Welcome back to your learning journey!</div>
                </div>
                <div>
                    <button onclick="logout()" style="padding: 10px 20px; background: white; color: #2E7D32; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-number" id="summaryCount">0</div>
                <div class="stat-label">Summaries Created</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üóÇÔ∏è</div>
                <div class="stat-number" id="flashcardCount">0</div>
                <div class="stat-label">Flashcard Sets</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-number" id="examCount">0</div>
                <div class="stat-label">Exams Taken</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-number" id="avgScore">0%</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>
        
        <!-- Summaries Section -->
        <div class="section">
            <h2 class="section-title">üìä Your Summaries</h2>
            <div id="summariesList" class="materials-grid">
                <!-- Summaries will be loaded here -->
            </div>
        </div>
        
        <!-- Flashcards Section -->
        <div class="section">
            <h2 class="section-title">üóÇÔ∏è Your Flashcards</h2>
            <div id="flashcardsList" class="materials-grid">
                <!-- Flashcards will be loaded here -->
            </div>
        </div>
        
        <!-- Exams Section -->
        <div class="section">
            <h2 class="section-title">üìù Your Exams</h2>
            <div id="examsList" class="materials-grid">
                <!-- Exams will be loaded here -->
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav-buttons">
            <button class="nav-btn" onclick="window.location.href='/'">
                ‚Üê Back to Study Tools
            </button>
            <button class="nav-btn" onclick="refreshDashboard()">
                üîÑ Refresh Dashboard
            </button>
        </div>
    </div>
    
    <!-- Modal for viewing materials -->
    <div id="materialModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">√ó</button>
            <h2 class="modal-title" id="modalTitle">Material</h2>
            <div id="modalContent">
                <!-- Material content will be loaded here -->
            </div>
            <div id="modalActions" class="material-actions" style="margin-top: 20px;">
                <!-- Action buttons will be loaded here -->
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin + "/api";
        
        // Check if user is logged in
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('is_logged_in');
            const username = localStorage.getItem('username');
            const userId = localStorage.getItem('user_id');
            
            if (!isLoggedIn || isLoggedIn !== 'true' || !username || !userId) {
                window.location.href = '/login';
                return false;
            }
            
            document.getElementById('usernameDisplay').textContent = `üë§ ${username}`;
            return true;
        }
        
        // Load dashboard data
        async function loadDashboard() {
            if (!checkAuth()) return;
            
            try {
                // Load user materials
                const [summariesRes, flashcardsRes, examsRes] = await Promise.all([
                    fetch(API_URL + "/user/materials"),
                    fetch(API_URL + "/user/flashcards"),
                    fetch(API_URL + "/user/exams")
                ]);
                
                const summariesData = await summariesRes.json();
                const flashcardsData = await flashcardsRes.json();
                const examsData = await examsRes.json();
                
                // Update statistics
                document.getElementById('summaryCount').textContent = summariesData.count || 0;
                document.getElementById('flashcardCount').textContent = flashcardsData.count || 0;
                document.getElementById('examCount').textContent = examsData.count || 0;
                
                // Calculate average score
                let totalScore = 0;
                let totalExams = 0;
                if (examsData.exams) {
                    examsData.exams.forEach(exam => {
                        if (exam.score !== undefined && exam.total_possible !== undefined) {
                            totalScore += (exam.score / exam.total_possible) * 100;
                            totalExams++;
                        }
                    });
                }
                const avgScore = totalExams > 0 ? Math.round(totalScore / totalExams) : 0;
                document.getElementById('avgScore').textContent = `${avgScore}%`;
                
                // Display materials
                displaySummaries(summariesData.materials || []);
                displayFlashcards(flashcardsData.flashcards || []);
                displayExams(examsData.exams || []);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Failed to load dashboard data. Please try again.');
            }
        }
        
        // Display summaries
        function displaySummaries(summaries) {
            const container = document.getElementById('summariesList');
            
            if (!summaries || summaries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h3>No summaries yet</h3>
                        <p>Create your first summary using the study tools!</p>
                        <button onclick="window.location.href='/'" style="margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Create Summary
                        </button>
                    </div>
                `;
                return;
            }
            
            // Show only the 10 most recent summaries
            const recentSummaries = summaries.slice(-10).reverse();
            
            container.innerHTML = recentSummaries.map(summary => `
                <div class="material-card">
                    <div class="material-header">
                        <div class="material-title">${summary.topic || 'Untitled Summary'}</div>
                        <div class="material-date">${formatDate(summary.created_at)}</div>
                    </div>
                    <div class="material-content">
                        ${summary.content ? summary.content.substring(0, 150) + '...' : 'No content'}
                    </div>
                    <div class="material-actions">
                        <button class="action-btn review-btn" onclick="viewSummary('${summary.id}')">
                            üëÅÔ∏è Review
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteMaterial('${summary.id}', 'summary')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Display flashcards
        function displayFlashcards(flashcards) {
            const container = document.getElementById('flashcardsList');
            
            if (!flashcards || flashcards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üóÇÔ∏è</div>
                        <h3>No flashcards yet</h3>
                        <p>Create your first flashcard set using the study tools!</p>
                        <button onclick="window.location.href='/'" style="margin-top: 15px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Create Flashcards
                        </button>
                    </div>
                `;
                return;
            }
            
            // Show only the 10 most recent flashcard sets
            const recentFlashcards = flashcards.slice(-10).reverse();
            
            container.innerHTML = recentFlashcards.map(flashcard => `
                <div class="material-card">
                    <div class="material-header">
                        <div class="material-title">${flashcard.category || 'Flashcards'}</div>
                        <div class="material-date">${formatDate(flashcard.created_at)}</div>
                    </div>
                    <div class="material-content">
                        ${flashcard.front ? 'Q: ' + flashcard.front.substring(0, 100) + '...' : 'Flashcard set'}
                    </div>
                    <div class="material-actions">
                        <button class="action-btn review-btn" onclick="viewFlashcards('${flashcard.id}')">
                            üëÅÔ∏è Review
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteMaterial('${flashcard.id}', 'flashcards')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function displayExams(exams) {
    const container = document.getElementById('examsList');
    
    if (!exams || exams.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìù</div>
                <h3>No exams yet</h3>
                <p>Take your first practice exam using the study tools!</p>
                <button onclick="window.location.href='/'" style="margin-top: 15px; padding: 10px 20px; background: #9C27B0; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Start Exam
                </button>
            </div>
        `;
        return;
    }
    
    // Show only the 5 most recent exams
    const recentExams = exams.slice(-5).reverse();
    
    container.innerHTML = recentExams.map(exam => {
        // Get score and total
        const score = exam.score || 0;
        const total = exam.total_points || (exam.questions ? exam.questions.length * 10 : 100);
        
        // Calculate percentage - use stored percentage or calculate
        let percentage = exam.percentage;
        if (percentage === undefined && total > 0) {
            percentage = Math.round((score / total) * 100);
        }
        percentage = percentage || 0;
        
        // Determine grade
        const grade = exam.grade || 
            (percentage >= 90 ? 'A' : 
             percentage >= 80 ? 'B' : 
             percentage >= 70 ? 'C' : 
             percentage >= 60 ? 'D' : 'F');
        
        // Format date
        const examDate = exam.completed_at || exam.created_at || new Date().toISOString();
        
        return `
        <div class="material-card">
            <div class="material-header">
                <div class="material-title">${exam.type || 'Exam'} - ${grade}</div>
                <div class="material-date">${formatDate(examDate)}</div>
            </div>
            <div class="material-content">
                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                    <span>Score: ${score}/${total}</span>
                    <span style="color: ${percentage >= 70 ? '#4CAF50' : percentage >= 50 ? '#FF9800' : '#f44336'}">
                        ${percentage}%
                    </span>
                </div>
                <div>${exam.total_questions || (exam.questions ? exam.questions.length : '?')} questions</div>
                ${exam.correct_count !== undefined ? 
                    `<div>Correct: ${exam.correct_count}/${exam.total_questions || exam.questions.length}</div>` : ''}
            </div>
            <div class="material-actions">
                <button class="action-btn review-btn" onclick="viewExam('${exam.exam_id}')">
                    üëÅÔ∏è Review
                </button>
                <button class="action-btn delete-btn" onclick="deleteMaterial('${exam.exam_id}', 'exam')">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
        `;
    }).join('');
}
        
        // View a summary in modal
        async function viewSummary(summaryId) {
            try {
                const response = await fetch(API_URL + `/get_summary/${summaryId}`);
                const data = await response.json();
                
                if (data.success) {
                    const summary = data.summary;
                    document.getElementById('modalTitle').textContent = `üìä ${summary.topic}`;
                    document.getElementById('modalContent').innerHTML = `
                        <div style="color: #666; margin-bottom: 15px;">
                            Created: ${formatDate(summary.created_at)}
                        </div>
                        <div style="white-space: pre-wrap; line-height: 1.6; max-height: 60vh; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            ${summary.content}
                        </div>
                    `;
                    
                    document.getElementById('modalActions').innerHTML = `
                        <button class="action-btn review-btn" onclick="useInStudyTools('${summary.content.replace(/'/g, "\\'")}')">
                            üìö Use in Study Tools
                        </button>
                        <button class="action-btn" style="background: #2196F3; color: white;" onclick="copyToClipboard('${summary.content.replace(/'/g, "\\'")}')">
                            üìã Copy to Clipboard
                        </button>
                    `;
                    
                    document.getElementById('materialModal').style.display = 'flex';
                } else {
                    alert(data.error || 'Failed to load summary');
                }
            } catch (error) {
                console.error('Error viewing summary:', error);
                alert('Failed to load summary');
            }
        }
        
        // View flashcards in modal
        async function viewFlashcards(flashcardId) {
            try {
                const response = await fetch(API_URL + `/get_flashcards/${flashcardId}`);
                const data = await response.json();
                
                if (data.success) {
                    const flashcardSet = data.flashcards;
                    document.getElementById('modalTitle').textContent = `üóÇÔ∏è ${flashcardSet.category || 'Flashcards'}`;
                    
                    let content = '';
                    if (flashcardSet.cards && Array.isArray(flashcardSet.cards)) {
                        content = flashcardSet.cards.map((card, index) => `
                            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <strong style="color: #2E7D32;">Card ${index + 1}</strong>
                                    <span style="background: #E8F5E9; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${card.difficulty || 'Medium'}
                                    </span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Q:</strong> ${card.front || 'No question'}
                                </div>
                                <div>
                                    <strong>A:</strong> ${card.back || 'No answer'}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        // Handle single flashcard
                        content = `
                            <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="margin-bottom: 10px;">
                                    <strong>Q:</strong> ${flashcardSet.front || 'No question'}
                                </div>
                                <div>
                                    <strong>A:</strong> ${flashcardSet.back || 'No answer'}
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('modalContent').innerHTML = `
                        <div style="color: #666; margin-bottom: 15px;">
                            Created: ${formatDate(flashcardSet.created_at)}
                        </div>
                        <div style="max-height: 60vh; overflow-y: auto;">
                            ${content}
                        </div>
                    `;
                    
                    document.getElementById('modalActions').innerHTML = `
                        <button class="action-btn review-btn" onclick="startFlashcardStudy('${flashcardId}')">
                            üéì Study These Cards
                        </button>
                        <button class="action-btn" style="background: #FF9800; color: white;" onclick="exportFlashcards('${flashcardId}')">
                            üì§ Export
                        </button>
                    `;
                    
                    document.getElementById('materialModal').style.display = 'flex';
                } else {
                    alert(data.error || 'Failed to load flashcards');
                }
            } catch (error) {
                console.error('Error viewing flashcards:', error);
                alert('Failed to load flashcards');
            }
        }
        
        // Update the viewExam function in dashboard.html:

async function viewExam(examId) {
    try {
        const response = await fetch(API_URL + `/get_exam/${examId}`);
        const data = await response.json();
        
        if (data.success) {
            const exam = data.exam;
            const score = exam.final_score || exam.score || 0;
            const total = exam.total_points || exam.total_possible || (exam.questions ? exam.questions.length * 10 : 100);
            const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
            const grade = exam.grade || getGradeFromPercentage(percentage);
            
            document.getElementById('modalTitle').textContent = `üìù ${exam.type || 'Exam'} Results`;
            
            let questionsContent = '';
            if (exam.questions && Array.isArray(exam.questions)) {
                questionsContent = exam.questions.map((q, index) => {
                    const userAnswer = q.user_answer || 'Not answered';
                    const isCorrect = q.user_answer === q.correct_answer;
                    return `
                    <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${isCorrect ? '#4CAF50' : '#f44336'};">
                        <div style="font-weight: bold; margin-bottom: 5px;">Question ${index + 1}:</div>
                        <div style="margin-bottom: 8px;">${q.question || 'No question text'}</div>
                        <div style="margin-bottom: 5px; font-size: 0.9em;">
                            <span style="color: ${isCorrect ? '#4CAF50' : '#f44336'}">
                                Your answer: ${userAnswer} ${isCorrect ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            Correct answer: ${q.correct_answer || 'Not specified'}
                        </div>
                        ${q.explanation ? `<div style="font-size: 0.9em; color: #666; margin-top: 5px;">Explanation: ${q.explanation}</div>` : ''}
                    </div>
                    `;
                }).join('');
            }
            
            document.getElementById('modalContent').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #E8F5E9; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold;">${percentage}%</div>
                        <div style="font-size: 0.9em;">Accuracy</div>
                    </div>
                    <div style="background: #E3F2FD; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold;">${grade}</div>
                        <div style="font-size: 0.9em;">Grade</div>
                    </div>
                    <div style="background: #FFF3CD; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold;">${exam.correct_count || 'N/A'}/${exam.total_questions || (exam.questions ? exam.questions.length : 0)}</div>
                        <div style="font-size: 0.9em;">Correct/Total</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2E7D32; margin-bottom: 10px;">Exam Questions:</h3>
                    ${questionsContent || '<p>No question details available.</p>'}
                </div>
            `;
            
            document.getElementById('modalActions').innerHTML = `
                <button class="action-btn review-btn" onclick="retakeExam('${examId}')">
                    üîÑ Retake This Exam
                </button>
                <button class="action-btn" style="background: #9C27B0; color: white;" onclick="analyzeExamResults('${examId}')">
                    üìà Analyze Results
                </button>
                <button class="action-btn" style="background: #4CAF50; color: white;" onclick="useExamAsStudyMaterial('${examId}')">
                    üìö Study Questions
                </button>
            `;
            
            document.getElementById('materialModal').style.display = 'flex';
        } else {
            alert(data.error || 'Failed to load exam');
        }
    } catch (error) {
        console.error('Error viewing exam:', error);
        alert('Failed to load exam');
    }
}

// Update the retakeExam function:
function retakeExam(examId) {
    // Store the exam ID for retake and redirect to main page
    localStorage.setItem('exam_to_retake', examId);
    window.location.href = '/';
    closeModal();
}
        
        // Delete a material
        async function deleteMaterial(materialId, type) {
            if (!confirm(`Are you sure you want to delete this ${type}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(API_URL + `/delete_material/${materialId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Material deleted successfully');
                    loadDashboard(); // Refresh the dashboard
                } else {
                    alert(data.error || 'Failed to delete material');
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }
        
        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                return dateString;
            }
        }
        
        function getGradeFromPercentage(percentage) {
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }
        
        function closeModal() {
            document.getElementById('materialModal').style.display = 'none';
        }
        
        function refreshDashboard() {
            loadDashboard();
        }
        
        function useInStudyTools(content) {
            localStorage.setItem('saved_content', content);
            window.location.href = '/';
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Content copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        }
        
        function startFlashcardStudy(flashcardId) {
            localStorage.setItem('study_flashcards', flashcardId);
            window.location.href = '/';
        }
        
        function retakeExam(examId) {
            localStorage.setItem('retake_exam', examId);
            window.location.href = '/';
        }
        
        function analyzeExamResults(examId) {
            // In a real implementation, this would show detailed analytics
            alert('Exam analysis feature would show detailed performance metrics, weak areas, and study recommendations.');
        }
        
        function exportFlashcards(flashcardId) {
            // In a real implementation, this would export flashcards
            alert('Export feature would allow you to download flashcards as PDF, CSV, or Anki format.');
        }
        
        async function logout() {
            try {
                const userId = localStorage.getItem('user_id');
                await fetch(API_URL + "/logout", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ user_id: userId })
                });
                localStorage.clear();
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        // Add this function to your dashboard.html JavaScript
async function loadDashboard() {
    if (!checkAuth()) return;
    
    try {
        // Load user materials
        const [summariesRes, flashcardsRes, examsRes] = await Promise.all([
            fetch(API_URL + "/user/materials"),
            fetch(API_URL + "/user/flashcards"),
            fetch(API_URL + "/user/exams")
        ]);
        
        const summariesData = await summariesRes.json();
        const flashcardsData = await flashcardsRes.json();
        const examsData = await examsRes.json();
        
        // Update statistics
        document.getElementById('summaryCount').textContent = summariesData.count || 0;
        document.getElementById('flashcardCount').textContent = flashcardsData.count || 0;
        document.getElementById('examCount').textContent = examsData.count || 0;
        
        // Calculate average accuracy
        let totalAccuracy = 0;
        let examsWithAccuracy = 0;
        if (examsData.exams && examsData.exams.length > 0) {
            examsData.exams.forEach(exam => {
                if (exam.percentage !== undefined) {
                    totalAccuracy += exam.percentage;
                    examsWithAccuracy++;
                } else if (exam.score !== undefined && exam.total_points !== undefined) {
                    const percentage = (exam.score / exam.total_points) * 100;
                    totalAccuracy += percentage;
                    examsWithAccuracy++;
                }
            });
        }
        
        const avgAccuracy = examsWithAccuracy > 0 ? Math.round(totalAccuracy / examsWithAccuracy) : 0;
        document.getElementById('avgScore').innerHTML = `${avgAccuracy}%`;
        
        // Display materials
        displaySummaries(summariesData.materials || []);
        displayFlashcards(flashcardsData.flashcards || []);
        displayExams(examsData.exams || []);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Failed to load dashboard data. Please try again.');
    }
}
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // Close modal when clicking outside
            document.getElementById('materialModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });

        // Add this at the end of your dashboard.html JavaScript
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();  // This should exist now
    
    // Close modal when clicking outside
    document.getElementById('materialModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
});
    </script>
</body>
</html>

